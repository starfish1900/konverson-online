<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konverson Online</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --board-bg: #2d2d2d;
            --squex-border: #404040;
            --highlight: rgba(255, 255, 255, 0.1);
            
            --color-A: #ff4d4d; /* Red */
            --color-C: #00ff00; /* Pure Green */
            --color-B: #4d79ff; /* Blue */
            --color-D: #ffff00; /* Pure Yellow */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* --- Lobby Styles --- */
        #lobby {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            justify-content: flex-start;
            height: 100vh;
            width: 100%;
            background: #222;
            z-index: 100;
            position: absolute;
            top: 0; left: 0;
            padding-top: 50px;
            box-sizing: border-box;
        }
        
        .lobby-card {
            background: #333;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 300px;
        }

        input, select { 
            padding: 10px; 
            font-size: 1rem; 
            border-radius: 4px; 
            border: none; 
            margin-bottom: 5px;
        }

        /* Lobby Lists Container */
        .lobby-container {
            display: flex;
            gap: 20px;
            width: 95%; /* Increased width utilization */
            max-width: 1000px;
            flex-wrap: wrap; 
            justify-content: center;
        }

        .lobby-panel {
            background: #333;
            padding: 1rem; 
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            flex: 1;
            min-width: 240px;
            display: flex;
            flex-direction: column;
            height: 60vh;
        }

        .lobby-panel h2 { margin-top: 0; color: #4dffff; border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 1.2rem; }
        
        .game-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .game-card {
            background: #444;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .game-card:hover { background: #555; }
        .game-info { display: flex; flex-direction: column; text-align: left; }
        .game-size { font-weight: bold; font-size: 1rem; color: #fff; }
        .game-meta { font-size: 0.8rem; color: #aaa; }
        
        .btn-action { background: #28a745; color: white; padding: 5px 15px; border-radius: 4px; font-size: 0.9rem; }
        .btn-watch { background: #17a2b8; }
        .btn-resume { background: #ffc107; color: #000; }

        /* Create Game Section */
        #create-panel {
            width: 95%;
            max-width: 1000px;
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap; 
        }
        
        /* --- Game Styles --- */
        #game-interface { display: none; width: 100%; max-width: 1000px; padding: 20px; flex-direction: column; align-items: center; }
        
        #header-info {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: #333;
            padding: 10px 20px;
            border-radius: 8px;
        }

        #main-area {
            display: flex;
            flex-direction: row;
            gap: 20px;
            align-items: flex-start;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
        }

        #stats-box {
            background-color: #2d2d2d;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stat-row { display: flex; justify-content: space-between; padding: 8px; border-radius: 4px; }
        .stat-row.active { background-color: rgba(255, 255, 255, 0.1); border-left: 3px solid #fff; }
        
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .dot.bg-A { background-color: var(--color-A); }
        .dot.bg-B { background-color: var(--color-B); }
        .dot.bg-C { background-color: var(--color-C); }
        .dot.bg-D { background-color: var(--color-D); }

        #board {
            display: grid;
            gap: 2px;
            background-color: var(--board-bg);
            border: 5px solid #555;
            padding: 5px;
            width: 100%;
            max-width: 600px;
        }

        .squex {
            background-color: #383838;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .squex.valid-move { background-color: rgba(100, 255, 100, 0.15); }

        /* Pawn Styles */
        .pawn { width: 70%; height: 70%; z-index: 2; transition: all 0.3s; }
        .pawn.new { border-radius: 3px; border: 2px solid #fff; }
        .pawn.old { border-radius: 50%; border: 2px solid rgba(0,0,0,0.2); transform: scale(0.9); }
        .pawn.color-A { background-color: var(--color-A); }
        .pawn.color-B { background-color: var(--color-B); }
        .pawn.color-C { background-color: var(--color-C); }
        .pawn.color-D { background-color: var(--color-D); }

        /* Animations */
        .pawn.converting::after {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; 
            background-color: var(--old-color); border-radius: 50%; z-index: 5;
            animation: piecemealErode 3s ease-in-out forwards;
        }
        @keyframes piecemealErode {
            0% { clip-path: circle(100%); }
            100% { clip-path: circle(0%); opacity: 0; }
        }
        .pawn.winning { animation: winPulse 1.2s infinite; border-color: #fff !important; border-width: 3px !important; }
        @keyframes winPulse { 50% { transform: scale(1.15); box-shadow: 0 0 20px #fff; } }

        button { background: #444; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; }
        button:hover { background: #555; }
        select { padding: 10px; font-size: 1rem; border-radius: 4px; border: none; margin-left: 10px; }
        
        .notification { color: #ff6b6b; font-weight: bold; min-height: 20px; text-align: center; margin-bottom: 10px; }
        .room-display { font-size: 1.5rem; font-weight: bold; color: #4dffff; letter-spacing: 2px; }
        .token-display { font-size: 0.7rem; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<!-- LOBBY SCREEN -->
<div id="lobby">
    <h1>Konverson Online Lobby</h1>
    
    <div id="create-panel">
        <label for="board-size-select" style="color:#ccc;">New Game Size:</label>
        <select id="board-size-select">
            <option value="9">9 x 9</option>
            <option value="11">11 x 11</option>
            <option value="13" selected>13 x 13</option>
            <option value="15">15 x 15</option>
        </select>
        <button id="btn-create">Create & Play</button>
    </div>

    <div class="lobby-container">
        <!-- Open Games (Waiting for Player 2) -->
        <div class="lobby-panel">
            <h2>Join a Game (Open)</h2>
            <div id="list-open" class="game-list">
                <div style="color:#666; text-align:center; padding:20px;">Loading games...</div>
            </div>
        </div>

        <!-- Active Games (Spectate) -->
        <div class="lobby-panel">
            <h2>Watch a Game (Live)</h2>
            <div id="list-active" class="game-list">
                <div style="color:#666; text-align:center; padding:20px;">Loading games...</div>
            </div>
        </div>
    </div>
</div>

<!-- GAME INTERFACE -->
<div id="game-interface">
    <div id="header-info">
        <button id="btn-leave" style="background:#555; font-size:0.8rem;">&larr; Lobby</button>
        <div>Room: <span id="room-id-display" class="room-display">---</span></div>
        <div>You are: <span id="my-team-display" style="font-weight:bold;">---</span></div>
        <div id="status-text">Waiting for opponent...</div>
    </div>

    <div class="notification" id="notification-area"></div>

    <div id="main-area">
        <div id="stats-box">
            <h3>Turn Succession</h3>
            <div class="stat-row" id="stat-A"><div class="color-label"><span class="dot bg-A"></span> A</div><span class="count">0</span></div>
            <div class="stat-row" id="stat-B"><div class="color-label"><span class="dot bg-B"></span> B</div><span class="count">0</span></div>
            <div class="stat-row" id="stat-C"><div class="color-label"><span class="dot bg-C"></span> C</div><span class="count">0</span></div>
            <div class="stat-row" id="stat-D"><div class="color-label"><span class="dot bg-D"></span> D</div><span class="count">0</span></div>
        </div>

        <div id="board"></div>
    </div>
</div>

<!-- Socket.io -->
<script src="/socket.io/socket.io.js"></script>

<script>
    // --- 1. Identity Management (Production Mode: localStorage Only) ---
    function getPlayerToken() {
        let token = localStorage.getItem('konverson_token');
        if (!token) {
            token = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('konverson_token', token);
        }
        return token;
    }

    const playerToken = getPlayerToken();

    const socket = io({
        auth: { token: playerToken }
    });
    
    // --- Shared Logic Classes (Rendering Only) ---
    const DIRS = [[-1, -1], [-1, 0], [-1, 1], [0, -1], [0, 1], [1, -1], [1, 0], [1, 1]];
    const ZONE_INTERIOR = 0; const ZONE_PREBORDER = 1; const ZONE_BORDER = 2; const ZONE_CORNER = 3;

    class GameState {
        constructor(size) {
            this.size = size;
            this.grid = []; 
            this.turnIndex = 0;
            this.placementsLeft = 1;
            this.firstPawnLoc = null;
            this.winner = null;
            this.winningPath = null;
        }

        static fromData(data) {
            const game = new GameState(data.size);
            Object.assign(game, data);
            return game;
        }

        getZone(r, c) {
            const last = this.size - 1;
            if ((r===0 && c===0) || (r===0 && c===last) || (r===last && c===0) || (r===last && c===last)) return ZONE_CORNER;
            if (r===0 || r===last || c===0 || c===last) return ZONE_BORDER;
            if (r===1 || r===last-1 || c===1 || c===last-1) return ZONE_PREBORDER;
            return ZONE_INTERIOR;
        }

        hasNeighbor(r, c, zoneType = null) {
            for (let d of DIRS) {
                const nr = r + d[0], nc = c + d[1];
                if (nr >= 0 && nr < this.size && nc >= 0 && nc < this.size) {
                    if (this.grid[nr][nc]) {
                        if (zoneType === null) return true;
                        if (this.getZone(nr, nc) === zoneType) return true;
                    }
                }
            }
            return false;
        }

        hasDiagonalPreborderNeighbor(r, c) {
            const dr = (r === 0) ? 1 : -1; const dc = (c === 0) ? 1 : -1;
            const nr = r + dr; const nc = c + dc;
            return (this.grid[nr][nc] !== null);
        }

        isValidMove(r, c) {
            if (this.winner || this.grid[r][c] !== null) return false;
            if (this.firstPawnLoc) {
                const dist = Math.max(Math.abs(r - this.firstPawnLoc.r), Math.abs(c - this.firstPawnLoc.c));
                if (dist < 3) return false;
            }
            const zone = this.getZone(r, c);
            if (zone === ZONE_INTERIOR) return true;
            if (zone === ZONE_PREBORDER) return this.hasNeighbor(r, c, ZONE_INTERIOR);
            if (zone === ZONE_BORDER) return this.hasNeighbor(r, c, ZONE_PREBORDER);
            if (zone === ZONE_CORNER) return this.hasDiagonalPreborderNeighbor(r, c);
            return false;
        }
        
        getCurrentColor() {
            return ['A', 'B', 'C', 'D'][this.turnIndex];
        }
    }

    // --- Client State ---
    let game = null;
    let myTeam = null; 
    let currentRoomId = null;

    // --- UI Elements ---
    const lobbyDiv = document.getElementById('lobby');
    const gameDiv = document.getElementById('game-interface');
    const boardEl = document.getElementById('board');
    const notif = document.getElementById('notification-area');
    const listOpen = document.getElementById('list-open');
    const listActive = document.getElementById('list-active');
    
    // --- Socket Listeners ---

    socket.on('connect_error', (err) => {
        alert("Connection Error: " + err.message);
    });

    socket.on('lobby_update', ({ openGames, activeGames }) => {
        renderLobbyLists(openGames, activeGames);
    });

    socket.on('game_created', (data) => enterGame(data));
    socket.on('game_joined', (data) => enterGame(data));

    socket.on('state_update', (serverGameState) => {
        game = GameState.fromData(serverGameState);
        render();
    });

    socket.on('game_over', (winner) => {
        document.getElementById('status-text').innerText = `GAME OVER - Winner: ${winner}`;
        document.getElementById('status-text').style.color = '#4dff4d';
        notif.innerText = `Game Over. Winner is ${winner}`;
    });

    socket.on('error_message', (msg) => {
        notif.innerText = msg;
        setTimeout(() => notif.innerText = "", 3000);
    });

    socket.on('message', (msg) => {
        notif.innerText = msg;
        setTimeout(() => notif.innerText = "", 5000);
    });

    // --- Interaction ---

    document.getElementById('btn-create').addEventListener('click', () => {
        const sizeVal = document.getElementById('board-size-select').value;
        socket.emit('create_game', { size: parseInt(sizeVal) });
    });

    document.getElementById('btn-leave').addEventListener('click', () => {
        socket.emit('leave_game', currentRoomId);
        gameDiv.style.display = 'none';
        lobbyDiv.style.display = 'flex';
        currentRoomId = null;
        game = null;
    });

    function joinGame(roomId) {
        socket.emit('join_game', roomId);
    }

    function renderLobbyLists(openGames, activeGames) {
        // --- Helper to create game card ---
        const createCard = (g, isResume) => {
            const el = document.createElement('div');
            el.className = 'game-card';
            
            let btnClass = 'btn-action';
            let btnText = 'Join';
            let statusText = `ID: ${g.id}`;

            if (isResume) {
                btnClass += ' btn-resume';
                btnText = 'Resume';
                statusText = `ID: ${g.id} (Playing)`;
            } else if (g.winner) {
                btnClass += ' btn-watch';
                btnText = 'View Results';
                statusText = `Ended: Winner ${g.winner}`;
            } else if (g.playerCount >= 2) {
                btnClass += ' btn-watch';
                btnText = 'Watch';
                statusText = `${g.spectatorCount} watching`;
            }

            el.innerHTML = `
                <div class="game-info">
                    <span class="game-size">Size: ${g.size}x${g.size}</span>
                    <span class="game-meta">${statusText}</span>
                </div>
                <button class="${btnClass}" onclick="joinGame('${g.id}')">${btnText}</button>
            `;
            return el;
        };

        // Render Open Games
        listOpen.innerHTML = '';
        if (openGames.length === 0) {
            listOpen.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No open games.</div>';
        } else {
            openGames.forEach(g => {
                const isResume = g.players.includes(playerToken);
                listOpen.appendChild(createCard(g, isResume));
            });
        }

        // Render Active Games
        listActive.innerHTML = '';
        if (activeGames.length === 0) {
            listActive.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No active games.</div>';
        } else {
            activeGames.forEach(g => {
                const isResume = g.players.includes(playerToken);
                listActive.appendChild(createCard(g, isResume));
            });
        }
    }

    // Expose for onClick
    window.joinGame = joinGame;

    function enterGame(data) {
        lobbyDiv.style.display = 'none';
        gameDiv.style.display = 'flex';
        
        currentRoomId = data.roomId;
        myTeam = data.team;
        game = GameState.fromData(data.gameState);
        
        document.getElementById('room-id-display').innerText = currentRoomId;
        
        const teamName = myTeam === 'AC' ? "Team 1 (Red/Green)" : (myTeam === 'BD' ? "Team 2 (Blue/Yellow)" : "Spectator");
        document.getElementById('my-team-display').innerText = teamName;
        
        initBoard();
        render();
    }

    function initBoard() {
        const size = game.size;
        boardEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        boardEl.innerHTML = '';
        
        for(let r=0; r<size; r++) {
            for(let c=0; c<size; c++) {
                const sq = document.createElement('div');
                sq.className = 'squex';
                sq.dataset.r = r;
                sq.dataset.c = c;
                sq.addEventListener('click', () => handleMove(r, c));
                const coord = document.createElement('span');
                coord.className = 'coord tl';
                sq.appendChild(coord); 
                boardEl.appendChild(sq);
            }
        }
    }

    function handleMove(r, c) {
        if (!game || game.winner) return;
        
        const currColor = game.getCurrentColor();
        const turnTeam = (currColor === 'A' || currColor === 'C') ? 'AC' : 'BD';
        
        if (myTeam !== turnTeam) {
            notif.innerText = (myTeam === 'spectator') ? "Spectating Only" : "Not your turn!";
            setTimeout(() => notif.innerText="", 2000);
            return;
        }

        if (game.isValidMove(r, c)) {
            socket.emit('make_move', { roomId: currentRoomId, r, c });
        } else {
            notif.innerText = "Invalid Move";
            setTimeout(() => notif.innerText="", 1000);
        }
    }

    function render() {
        const size = game.size;
        const currentColor = game.getCurrentColor();
        const turnTeam = (currentColor === 'A' || currentColor === 'C') ? 'AC' : 'BD';
        
        if(!game.winner) {
            if (myTeam === turnTeam) {
                document.getElementById('status-text').innerText = `YOUR TURN (${currentColor})`;
                document.getElementById('status-text').style.color = '#fff';
            } else {
                document.getElementById('status-text').innerText = `Opponent's Turn (${currentColor})`;
                document.getElementById('status-text').style.color = '#888';
            }
        } else {
             document.getElementById('status-text').innerText = `GAME OVER - Winner: ${game.winner}`;
             document.getElementById('status-text').style.color = '#4dff4d';
        }

        const counts = { A: 0, B: 0, C: 0, D: 0 };

        for(let r=0; r<size; r++) {
            for(let c=0; c<size; c++) {
                const sq = document.querySelector(`.squex[data-r='${r}'][data-c='${c}']`);
                const p = game.grid[r][c];
                const existingPawn = sq.querySelector('.pawn');

                if (!p && existingPawn) { existingPawn.remove(); continue; }

                if (p) {
                    counts[p.color]++;
                    let pawnDiv = existingPawn;
                    if (!pawnDiv || pawnDiv.dataset.id !== p.id) {
                        if (pawnDiv) pawnDiv.remove();
                        pawnDiv = document.createElement('div');
                        pawnDiv.dataset.id = p.id;
                        sq.appendChild(pawnDiv);
                        if (game.firstPawnLoc && game.firstPawnLoc.r === r && game.firstPawnLoc.c === c) {
                            pawnDiv.classList.add('appearing');
                        }
                    }

                    pawnDiv.className = `pawn color-${p.color} ${p.posture}`;

                    if (p.convertedRecently) {
                        pawnDiv.classList.add('converting');
                        pawnDiv.style.setProperty('--old-color', `var(--color-${p.prevColor})`);
                    } else {
                        pawnDiv.classList.remove('converting');
                        pawnDiv.style.removeProperty('--old-color');
                    }

                    if (game.winningPath && game.winningPath.some(wp => wp.r === r && wp.c === c)) {
                        pawnDiv.classList.add('winning');
                    } else {
                        pawnDiv.classList.remove('winning');
                    }
                }

                sq.classList.remove('valid-move');
                if (!game.winner && myTeam === turnTeam && game.isValidMove(r, c)) {
                    sq.classList.add('valid-move');
                }
            }
        }

        ['A','B','C','D'].forEach(c => {
            document.querySelector(`#stat-${c} .count`).innerText = counts[c];
            const row = document.getElementById(`stat-${c}`);
            if(c === currentColor && !game.winner) row.classList.add('active');
            else row.classList.remove('active');
        });
    }
</script>
</body>
</html>
